<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrollable PDF Viewer with PDF.js</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body, html {
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #pdf-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        .pdf-page {
            display: block;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .pdf-link {
            position: absolute;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
<div id="pdf-container"></div>

<script type="module">
    import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/+esm';

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/build/pdf.worker.mjs';

    const url = 'https://web-padawans-tent.github.io/new-year.github.io/Festive.pdf';
    const pdfContainer = document.getElementById('pdf-container');
    let pdfDoc = null;

    async function renderPDF() {
        if (!pdfDoc) {
            pdfDoc = await pdfjsLib.getDocument(url).promise;
        }

        if (!pdfDoc) return;

        pdfContainer.innerHTML = "";

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            await renderPage(pageNum);
        }
    }

    async function renderPage(pageNum) {
        const page = await pdfDoc.getPage(pageNum);

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        // Масштабируем страницу относительно ширины контейнера
        const scale = pdfContainer.clientWidth / page.getViewport({ scale: 1 }).width;
        const viewport = page.getViewport({ scale });

        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.style.width = `${viewport.width}px`;
        canvas.style.height = `${viewport.height}px`;

        const pageContainer = document.createElement('div');
        pageContainer.style.position = 'relative';
        pageContainer.classList.add('pdf-page');
        pageContainer.appendChild(canvas);

        await page.render({ canvasContext: context, viewport: viewport }).promise;

        const annotations = await page.getAnnotations();
        annotations.forEach((annotation) => {
            addLinkAnnotation(annotation, pageContainer, viewport);
        });

        pdfContainer.appendChild(pageContainer);
    }

    function addLinkAnnotation(annotation, pageContainer, viewport) {
        const [x1, y1, x2, y2] = annotation.rect;

        // Вычисляем позицию аннотации с учетом масштаба
        const scale = viewport.scale;
        const { width, height } = viewport;

        const left = x1 * scale;
        const top = (height - y2) * scale + 150; // Сдвигаем аннотацию вниз на 50px
        const linkWidth = (x2 - x1) * scale;
        const linkHeight = (y2 - y1) * scale;

        const link = document.createElement('a');
        link.className = 'pdf-link';
        link.style.left = `${left}px`;
        link.style.top = `${top}px`;
        link.style.width = `${linkWidth}px`;
        link.style.height = `${linkHeight}px`;

        if (annotation.url) {
            link.href = annotation.url;
            link.target = '_blank';
        } else if (annotation.dest) {
            const destinationPage = getDestinationPageNumber(annotation.dest);
            link.href = `#page-${destinationPage}`;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                goToDestination(annotation.dest);
            });
        }

        pageContainer.appendChild(link);
    }

    function getDestinationPageNumber(dest) {
        if (Array.isArray(dest) && dest.length > 0 && dest[0].num !== undefined) {
            return dest[0].num; // Используем правильный номер страницы
        }
        return 1; // Если dest не определен, возвращаем страницу 1
    }

    async function goToDestination(dest) {
        try {
            if (Array.isArray(dest) && dest.length > 0 && dest[0].num !== undefined) {
                const pageIndex = dest[0].num;
                const pageElements = document.querySelectorAll('#pdf-container > div');
                if (pageElements[pageIndex - 1]) {
                    pageElements[pageIndex - 1].scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                console.error('Неверный формат dest:', dest);
            }
        } catch (error) {
            console.error('Ошибка перехода к якорю:', error);
        }
    }

    // Функция для дебаунса при изменении размеров окна
    function debounce(func, delay) {
        let timeout;
        return function () {
            clearTimeout(timeout);
            timeout = setTimeout(func, delay);
        };
    }

    window.addEventListener('resize', debounce(renderPDF, 200));
    renderPDF();
</script>
</body>
</html>
