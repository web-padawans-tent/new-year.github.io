<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Scrollable PDF Viewer with PDF.js</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body,
            html {
                height: 100%;
                overflow: hidden;
                font-family: Arial, sans-serif;
            }
            #pdf-container {
                width: 100%;
                height: 100%;
                overflow-x: hidden;
                background-color: #f0f0f0;
            }
            .pdf-page {
                display: block;
                width: 100%;
            }
            .pdf-link {
                position: absolute;
            }
        </style>
    </head>
    <body>
        <div id="pdf-container"></div>

        <script type="module">
            import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/+esm';

            // Устанавливаем путь к воркеру
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/build/pdf.worker.mjs';

            // URL к PDF-файлу
            const url = 'https://web-padawans-tent.github.io/new-year.github.io/Festive.pdf';

            const pdfContainer = document.getElementById('pdf-container');

            let pdfDoc = null;

            async function renderPDF(pageNum) {
                pdfDoc = await pdfjsLib
                         .getDocument(url)
                         .promise;

                if (!pdfDoc) return;

                for (let pageNum = 1; pageNum <= 10; pageNum++) {
                    const page = await pdfDoc.getPage(pageNum);

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    const container = document.getElementById('pdf-container');
                    container.innerHTML = '';

                    const scale = container.clientWidth / page.getViewport({ scale: 1 }).width;
                    const viewport = page.getViewport({ scale: scale });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Создаем контейнер для страницы и ссылок
                    const pageContainer = document.createElement('div');
                    pageContainer.style.position = 'relative';
                    pdfContainer.appendChild(pageContainer);

                    // Обрабатываем аннотации (ссылки)
                    const annotations = await page.getAnnotations();
                        annotations.forEach(annotation => {
                            if (annotation.subtype === 'Link') {
                                addLinkAnnotation(annotation, pageContainer, viewport, pageNum);
                            }
                        });

                    page.render({
                    canvasContext: context,
                    viewport: viewport
                    });

                    container.appendChild(canvas);
                }
            }

            // Функция для рендеринга всех страниц PDF
            // async function renderPDF() {
            //     try {
            //         pdfDoc = await pdfjsLib
            //             .getDocument(url)
            //             .promise;
            //         console.log('PDF загружен');

            //         for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            //             const page = await pdfDoc.getPage(pageNum);
                        
            //             const scale = pdfContainer.clientWidth / page.getViewport({ scale: 1 }).width;
            //             const viewport = page.getViewport({ scale: scale });

                        // // Создаем контейнер для страницы и ссылок
                        // const pageContainer = document.createElement('div');
                        // pageContainer.style.position = 'relative';
                        // pdfContainer.appendChild(pageContainer);

                        // // Создаем canvas для рендеринга страницы
                        // const canvas = document.createElement('canvas');
                        // canvas.width = viewport.width;
                        // canvas.height = viewport.height;
                        // pageContainer.appendChild(canvas);

            //             const context = canvas.getContext('2d');

            //             // Рендерим страницу на canvas
            //             await page
            //                 .render({canvasContext: context, viewport: viewport})
            //                 .promise;

                        // // Обрабатываем аннотации (ссылки)
                        // const annotations = await page.getAnnotations();
                        // annotations.forEach(annotation => {
                        //     if (annotation.subtype === 'Link') {
                        //         addLinkAnnotation(annotation, pageContainer, viewport, pageNum);
                        //     }
                        // });
            //         }
            //     } catch (error) {
            //         console.error('Ошибка загрузки PDF:', error);
            //     }
            // }

            // Функция для добавления ссылок на страницу
            function addLinkAnnotation(annotation, pageContainer, viewport, currentPage) {
                const [x1, y1, x2, y2] = annotation.rect;
                const {width, height} = viewport;

                // Конвертируем координаты из PDF в координаты на странице
                const left = Math.min(x1, x2) * viewport.scale;
                const top = height - Math.max(y1, y2) * viewport.scale;
                const linkWidth = Math.abs(x2 - x1) * viewport.scale;
                const linkHeight = Math.abs(y2 - y1) * viewport.scale;

                const link = document.createElement('a');
                link.className = 'pdf-link';
                link.style.left = `${left}px`;
                link.style.top = `${top}px`;
                link.style.width = `${linkWidth}px`;
                link.style.height = `${linkHeight}px`;

                if (annotation.url) {
                    // Внешняя ссылка
                    link.href = annotation.url;
                    link.target = '_blank';
                } else if (annotation.dest) {
                    console.log(annotation);
                    // Получаем номер страницы назначения с учетом смещения на 4 страницы назад
                    const destinationPage = getDestinationPageNumber(annotation.dest); // Получаем номер страницы с учетом смещения
                    link.href = `#page-${destinationPage}`;  // Устанавливаем правильный href
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        goToDestination(annotation.dest);
                    });
                }

                pageContainer.appendChild(link);
            }

            // Функция для извлечения номера страницы из массива dest с учетом смещения на 4 страницы
            function getDestinationPageNumber(dest) {
                if (Array.isArray(dest) && dest.length > 0 && dest[0].num !== undefined) {
                    return Math.max(dest[0].num - 4, 0) + 1;  // Смещаем на 4 страницы назад, но не ниже первой страницы
                }
                return 1;  // Если не найдено, возвращаем первую страницу по умолчанию
            }

            async function goToDestination(dest) {
                try {
                    // Если dest — массив с объектом, получаем номер страницы из первого элемента
                    if (Array.isArray(dest) && dest.length > 0 && dest[0].num !== undefined) {
                        const pageIndex = dest[0].num; // Номер страницы (начинается с 0)
                        const pageNumber = pageIndex + 1 - 4; // Смещаем на 4 страницы назад

                        // Прокручиваем к нужной странице
                        const pageElements = document.querySelectorAll('#pdf-container > div');
                        if (pageElements[pageNumber - 1] && pageNumber > 0) {
                            pageElements[pageNumber - 1].scrollIntoView({behavior: 'smooth'});
                        }
                    } else {
                        console.error('Неверный формат dest:', dest);
                    }
                } catch (error) {
                    console.error('Ошибка перехода к якорю:', error);
                }
            }

            // Запускаем рендеринг PDF
            renderPDF(1);

            window.addEventListener('resize', () => {
                renderPDF(1);
            });
        </script>
    </body>
</html>