<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Scrollable PDF Viewer with PDF.js</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body,
            html {
                height: 100%;
                overflow: hidden;
                font-family: Arial, sans-serif;
            }
            #pdf-container {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                background-color: #f0f0f0;
                position: relative;
            }
            .pdf-page {
                display: block;
                width: 100%;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                background-color: #fff;
                position: relative;
            }
            .pdf-link {
                position: absolute;
                cursor: pointer;
                z-index: 10;
                border: 2px solid transparent;
                transition: border 0.2s ease;
            }
            .pdf-link:hover {
                border: 2px solid rgba(0, 0, 255, 0.5);
            }
        </style>
    </head>
    <body>
        <div id="pdf-container"></div>

        <script type="module">
            import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/+esm';

            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/build/pdf.worker.mjs';

            const url = 'https://web-padawans-tent.github.io/new-year.github.io/Festive.pdf';
            const pdfContainer = document.getElementById('pdf-container');
            let pdfDoc = null;

            async function renderPDF() {
                pdfDoc = await pdfjsLib
                    .getDocument(url)
                    .promise;

                for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    await renderPage(pageNum);
                }
            }

            async function renderPage(pageNum) {
                const page = await pdfDoc.getPage(pageNum);

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                const viewport = page.getViewport({scale: 1.5}); // Фиксированный scale для качества

                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = '100%';
                canvas.style.height = 'auto';

                const pageContainer = document.createElement('div');
                pageContainer
                    .classList
                    .add('pdf-page');
                pageContainer.appendChild(canvas);

                await page
                    .render({canvasContext: context, viewport})
                    .promise;

                const annotations = await page.getAnnotations();
                annotations.forEach((annotation) => {
                    addLinkAnnotation(annotation, pageContainer, viewport);
                });

                pdfContainer.appendChild(pageContainer);
            }

            function addLinkAnnotation(annotation, pageContainer, viewport) {
                const [x1, y1, x2, y2] = annotation.rect;
                const scale = viewport.scale; // Убрали влияние devicePixelRatio

                const left = (x1 * scale) / viewport.width * 100;
                const top = ((viewport.height - y2 * scale) / viewport.height) * 100;
                const linkWidth = ((x2 - x1) * scale) / viewport.width * 100;
                const linkHeight = ((y2 - y1) * scale) / viewport.height * 100;

                const link = document.createElement('a');
                link.className = 'pdf-link';
                link.style.left = `${left}%`;
                link.style.top = `${top}%`;
                link.style.width = `${linkWidth}%`;
                link.style.height = `${linkHeight}%`;

                console.log(`Link position: left=${left}%, top=${top}%`);

                if (annotation.url) {
                    link.href = annotation.url;
                    link.target = '_blank';
                }

                pageContainer.appendChild(link);
            }

            renderPDF();
        </script>
    </body>
</html>